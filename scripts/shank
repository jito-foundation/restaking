#!/bin/bash

# Determine the script's location and project root
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
PROJECT_ROOT="$( cd "$SCRIPT_DIR/../" &> /dev/null && pwd )"

# Directory containing the config files
CONFIG_DIR="${PROJECT_ROOT}/config"

# Output directory for IDL files
IDL_DIR="${PROJECT_ROOT}/idl"

# Ensure the IDL directory exists
mkdir -p "$IDL_DIR"

# Loop through all .env files in the config directory
for config_file in ${CONFIG_DIR}/*.env; do
    # Extract the network name from the filename
    network=$(basename ${config_file} .env)

    echo "Processing ${network}..."

    # Source the environment variables
    source ${config_file}

    # Run the shank idl commands
    shank idl --crate-root "${PROJECT_ROOT}/restaking_sdk" -p ${RESTAKING_PROGRAM_ID} -o "${IDL_DIR}/${network}"
    shank idl --crate-root "${PROJECT_ROOT}/vault_sdk" -p ${VAULT_PROGRAM_ID} -o "${IDL_DIR}/${network}"

    echo "Finished processing ${network}"
    echo "------------------------"
done

echo "All configurations processed."